{% load custom_filters %}

<div class="filter-section">
    {% if form %}
        <div class="filter-header">
            <h3>Filter Shows</h3>
            <button class="filter-reset" onclick="resetFilters()">Reset Filters</button>
        </div>

        <form method="get" id="filters-form">
            <div class="filter-grid">
                {% if exclude_location_filter != True %}
                    <div class="filter-item">
                        <label class="filter-label" for="id_location">Location</label>
                        {{ form.location|add_class:"filter-select" }}
                    </div>
                {% endif %}

                {% if exclude_film_filter != True %}
                    <div class="filter-item">
                        <label class="filter-label" for="id_film">Film</label>
                        {{ form.film|add_class:"filter-select" }}
                    </div>
                {% endif %}

                <div class="filter-item">
                    <label class="filter-label" for="id_status">Status</label>
                    {{ form.status|add_class:"filter-select" }}
                </div>
            </div>

            {% if form.location.value or form.film.value or form.status.value %}
                <div class="active-filters mt-3">
                    {% if form.location.value %}
                        <span class="filter-tag">
                            Location: {{ form.location|get_selected_object }}
                            <button type="button" onclick="clearFilter('location')" class="btn-close" aria-label="Remove filter"></button>
                        </span>
                    {% endif %}

                    {% if form.film.value %}
                        <span class="filter-tag">
                            Film: {{ form.film|get_selected_object }}
                            <button type="button" onclick="clearFilter('film')" class="btn-close" aria-label="Remove filter"></button>
                        </span>
                    {% endif %}

                    {% if form.status.value and form.status.value != 'all' %}
                        <span class="filter-tag">
                            Status: {{ form.status|get_selected_object }}
                            <button type="button" onclick="clearFilter('status')" class="btn-close" aria-label="Remove filter"></button>
                        </span>
                    {% endif %}
                </div>
            {% endif %}
        </form>
    {% endif %}
</div>

<div class="show-listings">
    {% for show in shows %}
        <div class="card show-card mb-4">

            <div class="card-body">
                <h5 class="card-title">
                    <a href="{% url 'blog_film' show.film.name %}">{{ show.film.name }}</a>
                    <a href="https://www.imdb.com/title/{{ show.film.imdb_code }}"
                       class="btn btn-sm ms-2 py-0 px-1"
                       style="background-color: #f5c518; color: #000000; border: 1px solid #000000;"
                       target="_blank"
                       rel="noopener noreferrer">
                        <i class="bi bi-film"></i> IMDb
                    </a>
                    {% if show.is_sold_out %}
                        <span class="badge bg-danger ms-2">SOLD OUT</span>
                    {% endif %}
                </h5>
                <h6 class="card-subtitle mb-2 text-muted">
                    {{ show.eventtime|date:"l, F j, Y" }} at {{ show.eventtime|time:"g:i A" }}
                </h6>
                <p class="card-text">
                    <strong>Location:</strong> <a href="{% url 'blog_location' show.location.name %}">{{ show.location }}</a><br>
                    <strong>Status:</strong> {{ show.get_status_display }}
                </p>

                <a href="{% url 'blog_detail' show.id %}" class="btn btn-primary btn-sm mb-2">
                    <i class="bi bi-info-circle"></i> Event Information
                </a>

                <!-- Show options display -->
                <div class="show-options mb-2">
                    {% for option in show.options.all %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i>{{ option.name }}
                        </span>
                    {% endfor %}
                </div>

                <div class="progress mt-3">
                    <div class="progress-bar {% if show.is_sold_out %}bg-danger{% elif show.credits >= show.location.min_capacity %}bg-success{% endif %}"
                         role="progressbar"
                         style="width:{% if show.credits < show.location.min_capacity %}{{ show.credits|default:0|multiply:100|divide:show.location.min_capacity }}{% else %}100{% endif %}%"
                         aria-valuenow="{{ show.credits|default:0 }}"
                         aria-valuemin="0"
                         aria-valuemax="{{ show.location.min_capacity }}">
                        {% if show.is_sold_out %}
                            SOLD OUT
                        {% elif show.credits >= show.location.min_capacity %}
                            ON SALE
                        {% else %}
                            {{ show.credits|default:0 }}/{{ show.location.min_capacity }} attendees required
                        {% endif %}
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted small">

                        Suggested by <a href="{% url 'profile' show.created_by.username %}">{{ show.created_by.username }}</a>

                    </div>
                </div>
            </div>
        </div>
    {% empty %}
        <div class="alert alert-info">No shows found.</div>
    {% endfor %}
</div>

{% block scripts %}
<script>
function clearFilter(filterName) {
    document.querySelector(`select[name="${filterName}"]`).value = '';
    document.getElementById('filters-form').submit();
}

function resetFilters() {
    document.querySelectorAll('.filter-select').forEach(select => {
        select.value = '';
    });
    document.getElementById('filters-form').submit();
}

document.querySelectorAll('.filter-select').forEach(function(select) {
    select.addEventListener('change', function() {
        document.getElementById('filters-form').submit();
    });
});
</script>
{% endblock %}
