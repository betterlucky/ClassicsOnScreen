{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block page_content %}
<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Available Films</h2>
        {% if user.is_authenticated %}
            <div>
                <span class="text-muted">
                    You have {{ votes_remaining }} votes remaining
                </span>
            </div>
        {% endif %}
    </div>

    <div class="alert alert-info mb-4">
        <h5><i class="bi bi-info-circle"></i> About Our Film Selection</h5>
        <p class="mb-0">
            Due to licensing agreements, we can only maintain a limited number of films as active on our platform. 
            {% if user.is_authenticated %}
                You can vote to keep your favorite films available - each user gets up to 10 votes, and votes expire after 30 days.
            {% else %}
                <a href="{% url 'login' %}">Log in</a> to vote for your favorite films and help keep them available.
            {% endif %}
            Learn more in our <a href="{% url 'blog_faq' %}#film-rotation">FAQ</a>.
        </p>
    </div>

    {% if top_films %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="h5 mb-0">Most Popular Films</h3>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                These films have received the most votes from our community in the last 30 days. 
                Films with the least votes are more likely to be rotated out to make room for new selections.
            </p>
            <div class="list-group list-group-flush">
                {% for film in top_films %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        {{ film.name }}
                        <span class="badge bg-primary rounded-pill">{{ film.vote_count }} votes</span>
                    </div>
                {% endfor %}
            </div>
            <div class="text-center mt-3">
                <small class="text-muted">
                    For the complete list, <a href="{% url 'most_desired_films' %}">click here</a>
                </small>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Search box -->
    <div class="card mb-4">
        <div class="card-body">
            <h4 class="h6 mb-3">Available Films for Screening</h4>
            <p class="text-muted mb-3">
                Browse our current selection of films available for screening. 
                {% if user.is_authenticated %}
                    Vote for your favorites to help keep them in rotation.
                {% else %}
                    Sign in to vote for your favorites.
                {% endif %}
            </p>
            <div class="input-group">
                <input type="text" 
                       id="filmSearch" 
                       class="form-control" 
                       placeholder="Search films..." 
                       value="{{ search_query }}"
                       aria-label="Search films">
                {% if search_query %}
                    <a href="{% url 'film_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i> Clear
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Films grid with no extra containers -->
    <div class="row g-3">  <!-- Using g-3 for gap -->
        {% for film in films %}
            <div class="col-12 col-sm-6 col-lg-4">  <!-- Changed breakpoint to lg -->
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title">{{ film.name }}</h5>
                            <a href="https://www.imdb.com/title/{{ film.imdb_code }}" 
                               class="badge bg-warning text-dark text-decoration-none" 
                               target="_blank">
                                IMDB
                            </a>
                        </div>
                        <p class="card-text text-muted">{{ film.description }}</p>
                        <div class="vote-container">
                            {% if user.is_authenticated %}
                                {% if film.id in user_voted_films %}
                                    <form method="post" action="{% url 'toggle_film_vote' film.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-vote voted">
                                            <i class="bi bi-heart-fill"></i> 
                                            <span class="vote-text">Remove Vote</span>
                                        </button>
                                    </form>
                                    <div class="vote-expiry">
                                        Vote expires in {{ days_remaining|get_item:film.id }} days
                                    </div>
                                {% else %}
                                    <form method="post" action="{% url 'toggle_film_vote' film.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-vote" {% if votes_remaining == 0 %}disabled{% endif %}>
                                            <i class="bi bi-heart"></i>
                                            <span class="vote-text">Vote to Keep</span>
                                        </button>
                                    </form>
                                {% endif %}
                            {% else %}
                                <small class="text-muted">
                                    <a href="{% url 'login' %}?next={{ request.path }}">Login to vote</a>
                                </small>
                            {% endif %}
                        </div>

                        {% if film.upcoming_shows.exists %}
                            <div class="mt-3">
                                <strong>Upcoming Shows:</strong>
                                <ul class="list-unstyled">
                                    {% for show in film.upcoming_shows|slice:":3" %}
                                        <li>
                                            <a href="{% url 'blog_detail' show.id %}">
                                                {{ show.eventtime|date:"D, M j" }} at {{ show.location.name }}
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12 no-results">
                <div class="alert alert-info">No films currently available.</div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static 'js/film_search.js' %}"></script>
{% endblock %} 