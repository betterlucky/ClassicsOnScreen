{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block page_content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Available Films</h2>
        {% if user.is_authenticated %}
            <div>
                <span class="text-muted">
                    You have {{ votes_remaining }} votes remaining
                </span>
            </div>
        {% endif %}
    </div>

    <div class="alert alert-info mb-4">
        <h5><i class="bi bi-info-circle"></i> About Our Film Selection</h5>
        <p class="mb-0">
            Due to licensing agreements, we can only maintain a limited number of films as active on our platform. 
            {% if user.is_authenticated %}
                You can vote to keep your favorite films available - each user gets up to 10 votes, and votes expire after 30 days.
            {% else %}
                <a href="{% url 'login' %}">Log in</a> to vote for your favorite films and help keep them available.
            {% endif %}
            Learn more in our <a href="{% url 'blog_faq' %}#film-rotation">FAQ</a>.
        </p>
    </div>

    {% if top_films %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="h5 mb-0">Most Popular Films</h3>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                These films have received the most votes from our community in the last 30 days. 
                Films with the least votes are more likely to be rotated out to make room for new selections.
            </p>
            <div class="list-group list-group-flush">
                {% for film in top_films %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        {{ film.name }}
                        <span class="badge bg-primary rounded-pill">{{ film.vote_count }} votes</span>
                    </div>
                {% endfor %}
            </div>
            <div class="text-center mt-3">
                <small class="text-muted">
                    For the complete list, <a href="{% url 'most_desired_films' %}">click here</a>
                </small>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Search box -->
    <div class="card mb-4">
        <div class="card-body">
            <h4 class="h6 mb-3">Available Films for Screening</h4>
            <p class="text-muted mb-3">
                Browse our current selection of films available for screening. 
                {% if user.is_authenticated %}
                    Vote for your favorites to help keep them in rotation.
                {% else %}
                    Sign in to vote for your favorites.
                {% endif %}
            </p>
            <div class="input-group">
                <input type="text" 
                       id="filmSearch" 
                       class="form-control" 
                       placeholder="Search films..." 
                       value="{{ search_query }}"
                       aria-label="Search films">
                {% if search_query %}
                    <a href="{% url 'film_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i> Clear
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Films grid -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="filmsContainer">
        {% for film in films %}
            <div class="col film-item" data-film-name="{{ film.name|lower }}">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title d-flex justify-content-between align-items-start">
                            {{ film.name }}
                            <a href="https://www.imdb.com/title/{{ film.imdb_code }}"
                               class="btn btn-sm ms-2 py-0 px-1"
                               style="background-color: #f5c518; color: #000000; border: 1px solid #000000;"
                               target="_blank"
                               rel="noopener noreferrer">
                                <i class="bi bi-film"></i> IMDb
                            </a>
                        </h5>
                        {% if film.description %}
                            <p class="card-text">{{ film.description }}</p>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="text-muted">{{ film.vote_count }} votes</span>
                            <form method="post" action="{% url 'toggle_film_vote' film.id %}" class="d-inline">
                                {% csrf_token %}
                                <div class="vote-container">
                                    {% if user.is_authenticated %}
                                        {% if film.id in user_voted_films %}
                                            <button type="submit" class="btn btn-vote voted">
                                                <i class="bi bi-heart-fill"></i> 
                                                <span class="vote-text">Remove Vote</span>
                                            </button>
                                            <div class="vote-expiry">
                                                Vote expires in {{ days_remaining|get_item:film.id }} days
                                            </div>
                                        {% else %}
                                            <button type="submit" class="btn btn-vote" {% if votes_remaining == 0 %}disabled{% endif %}>
                                                <i class="bi bi-heart"></i>
                                                <span class="vote-text">Vote to Keep</span>
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        <small class="text-muted">
                                            <a href="{% url 'login' %}?next={{ request.path }}">Login to vote</a>
                                        </small>
                                    {% endif %}
                                </div>
                            </form>
                        </div>

                        {% if film.upcoming_shows.exists %}
                            <div class="mt-3">
                                <strong>Upcoming Shows:</strong>
                                <ul class="list-unstyled">
                                    {% for show in film.upcoming_shows|slice:":3" %}
                                        <li>
                                            <a href="{% url 'blog_detail' show.id %}">
                                                {{ show.eventtime|date:"D, M j" }} at {{ show.location.name }}
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12 no-results">
                <div class="alert alert-info">No films currently available.</div>
            </div>
        {% endfor %}
    </div>
</div>

<script>
    // Your JavaScript code here
    document.getElementById('filmSearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const films = document.getElementsByClassName('film-item');
        let hasVisibleFilms = false;

        Array.from(films).forEach(film => {
            const filmName = film.dataset.filmName;
            if (filmName.includes(searchTerm)) {
                film.style.display = '';
                hasVisibleFilms = true;
            } else {
                film.style.display = 'none';
            }
        });

        // Show/hide no results message
        const noResults = document.querySelector('.no-results');
        if (noResults) {
            if (!hasVisibleFilms) {
                if (!document.querySelector('.no-results-message')) {
                    const message = document.createElement('div');
                    message.className = 'col-12 no-results-message';
                    message.innerHTML = '<div class="alert alert-info">No films match your search.</div>';
                    document.getElementById('filmsContainer').appendChild(message);
                }
            } else {
                const message = document.querySelector('.no-results-message');
                if (message) message.remove();
            }
        }
    });
</script>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static 'js/film_search.js' %}"></script>
{% endblock %} 