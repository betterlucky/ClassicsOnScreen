{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block page_content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Available Films</h2>
        {% if user.is_authenticated %}
            <div class="badge bg-primary p-2">
                <i class="bi bi-star-fill me-2"></i>
                {{ votes_remaining }} votes remaining
            </div>
        {% endif %}
    </div>

    <div class="alert alert-info mb-4">
        <h5><i class="bi bi-info-circle"></i> About Our Film Selection</h5>
        <p class="mb-0">
            Due to licensing agreements, we can only maintain a limited number of films as active on our platform. 
            {% if user.is_authenticated %}
                You can vote to keep your favorite films available - each user gets up to {{ MAX_FILM_VOTES }} votes, and votes expire after 30 days.
            {% else %}
                <a href="{% url 'login' %}">Log in</a> to vote for your favorite films and help keep them available.
            {% endif %}
            Learn more in our <a href="{% url 'blog_faq' %}#film-rotation">FAQ</a>.
        </p>
    </div>

    {% if top_films %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="h5 mb-0"><i class="bi bi-trophy me-2"></i>Most Popular Films</h3>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                These films have received the most votes from our community in the last 30 days. 
                Films with the least votes are more likely to be rotated out to make room for new selections.
            </p>
            <div class="list-group list-group-flush">
                {% for film in top_films %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-film me-2"></i>
                            {{ film.name }}
                        </div>
                        <span class="badge bg-primary rounded-pill">{{ film.vote_count }} votes</span>
                    </div>
                {% endfor %}
            </div>
            <div class="text-center mt-3">
                <a href="{% url 'most_desired_films' %}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-list-ul me-1"></i>View Complete List
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Search box -->
    <div class="card mb-4">
        <div class="card-body">
            <h4 class="h6 mb-3">Available Films for Screening</h4>
            <p class="text-muted mb-3">
                Browse our current selection of films available for screening. 
                {% if user.is_authenticated %}
                    Vote for your favorites to help keep them in rotation.
                {% else %}
                    Sign in to vote for your favorites.
                {% endif %}
            </p>
            <div class="input-group">
                <span class="input-group-text bg-white">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" 
                       id="filmSearch" 
                       class="form-control" 
                       placeholder="Search films..." 
                       value="{{ search_query }}"
                       aria-label="Search films">
                {% if search_query %}
                    <a href="{% url 'film_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i> Clear
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Films grid -->
    <div class="row justify-content-center g-3">
        {% for film in films %}
            <div class="col-12 col-md-4" style="max-width: 450px;">
                <div class="card show-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">{{ film.name }}</h5>
                            <a href="https://www.imdb.com/title/{{ film.imdb_code }}" 
                               class="btn btn-sm ms-2 py-0 px-1"
                               style="background-color: #f5c518; color: #000000; border: 1px solid #000000;"
                               target="_blank"
                               rel="noopener noreferrer">
                                <i class="bi bi-film"></i> IMDb
                            </a>
                        </div>
                        <p class="card-text text-muted">{{ film.description }}</p>
                        
                        {% if film.upcoming_shows.exists %}
                            <div class="mb-3">
                                <h6 class="mb-2"><i class="bi bi-calendar-event me-2"></i>Upcoming Shows</h6>
                                <ul class="list-unstyled">
                                    {% for show in film.upcoming_shows|slice:":3" %}
                                        <li class="mb-1">
                                            <a href="{% url 'blog_detail' show.id %}" class="text-decoration-none">
                                                <i class="bi bi-arrow-right-circle me-1"></i>
                                                {{ show.eventtime|date:"D, M j" }} at {{ show.location.name }}
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        <div class="vote-container mt-auto">
                            {% if user.is_authenticated %}
                                {% if film.id in user_voted_films %}
                                    <form method="post" action="{% url 'toggle_film_vote' film.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-vote voted w-100">
                                            <i class="bi bi-heart-fill"></i> 
                                            <span class="vote-text">Remove Vote</span>
                                        </button>
                                    </form>
                                    <div class="days-remaining text-center">
                                        Vote expires in {{ days_remaining|get_item:film.id }} days
                                    </div>
                                {% else %}
                                    <form method="post" action="{% url 'toggle_film_vote' film.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-vote w-100" {% if votes_remaining == 0 %}disabled{% endif %}>
                                            <i class="bi bi-heart"></i>
                                            <span class="vote-text">Vote to Keep</span>
                                        </button>
                                    </form>
                                {% endif %}
                            {% else %}
                                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-box-arrow-in-right me-1"></i>Login to Vote
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12 no-results">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>No films currently available.
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static 'js/film_search.js' %}"></script>
{% endblock %} 